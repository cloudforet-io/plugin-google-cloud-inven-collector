---
alwaysApply: true
---
# SpaceONE Google Cloud Collector: 코딩 컨벤션

이 문서는 SpaceONE Google Cloud Inventory Collector 플러그인 프로젝트의 일관성 있는 코드 스타일과 품질 유지를 위한 규칙을 정의합니다.

## 목차
1.  [이름 규칙 (Naming Conventions)](#1-이름-규칙-naming-conventions)
2.  [코드 포맷팅 및 린팅 (Code Formatting & Linting)](#2-코드-포맷팅-및-린팅-code-formatting--linting)
3.  [Import 규칙 (Import Rules)](#3-import-규칙-import-rules)
4.  [주석 및 문서화 (Comments & Documentation)](#4-주석-및-문서화-comments--documentation)
5.  [에러 처리 (Error Handling)](#5-에러-처리-error-handling)
6.  [테스트 (Testing)](#6-테스트-testing)
7.  [규칙 검증 스크립트](#7-규칙-검증-스크립트)

---

## 1. 이름 규칙 (Naming Conventions)

### 1.1. 공통 규칙
- **영문 사용**: 모든 코드(변수, 함수, 클래스 등)와 커밋 메시지는 영문으로 작성합니다.
- **Todo 주석**: `# TODO: ` 형식으로 작성하여 향후 처리할 작업을 명시합니다.

### 1.2. 디렉토리 및 파일
- **`snake_case` 사용**: `cloud_functions`, `data_source_manager.py`
- **단일 책임 원칙**: 모듈은 기능별로 명확하게 분리하고, 파일 이름에 그 기능이 드러나도록 작성합니다.
- **테스트 파일**: `test_` 접두사를 사용합니다. (예: `test_collector.py`)

### 1.3. 변수 및 상수
- **변수**: `snake_case`를 사용합니다. (예: `user_name`, `cost_data`)
- **상수**: `UPPER_SNAKE_CASE`를 사용합니다. (예: `MAX_RETRY_COUNT`)

### 1.4. 함수 및 메서드
- **`snake_case` 사용**: `get_cost_data`, `validate_parameters`
- **내부 사용 함수/메서드**: 클래스/모듈 내부에서만 사용하는 경우 `_` (protected) 또는 `__` (private)로 시작합니다. (예: `_get_internal_data`)
- **동사 중심 명명**:
  - **`get` / `list`**: 데이터를 조회할 때 사용합니다. `get`은 단일 객체, `list`는 여러 객체를 반환하는 경우에 사용합니다.
  - **`create`**: DB 저장이나 영구적인 리소스 생성을 목적으로 객체를 만들 때 사용합니다.
  - **`make`**: 다른 데이터를 조합하여 새로운 데이터(dict, list, query 등)를 메모리상에서 생성할 때 사용합니다.
  - **`generate`**: Key, Token 등 외부에 의존하지 않고 독립적으로 생성되는 값을 만들 때 사용합니다.

### 1.5. 클래스
- **`PascalCase` (CapWords) 사용**: `CostManager`, `HttpFileConnector`
- **에러 클래스**: `PascalCase`를 따르며, `Error` 접미사를 붙이는 것을 권장합니다. (예: `InvalidParameterError`)

---

## 2. 코드 포맷팅 및 린팅 (Code Formatting & Linting)

### 2.1. 주요 도구: Ruff
- **Ruff**: Rust 기반의 통합 Python 도구로, 린팅, 포맷팅, 임포트 정렬 등을 모두 처리합니다.
- **표준화**: 프로젝트의 모든 코드 스타일은 `Ruff`를 통해 관리됩니다.
- **설정**: 모든 규칙은 `pyproject.toml` 파일에서 관리합니다.

### 2.2. 레거시 도구
- `black`, `isort`, `flake8`, `pylint` 등의 기능은 모두 `Ruff`가 대체하므로, 신규 코드 작성 시 `Ruff` 사용을 원칙으로 합니다.

---

## 3. Import 규칙 (Import Rules)

### 3.1. 기본 원칙
- **절대 경로 사용**: 프로젝트 루트(`spaceone`)에서 시작하는 절대 경로를 사용하여 명확성을 높입니다.
  ```python
  # Good
  from spaceone.inventory.manager.cost_manager import CostManager

  # Bad
  from ..manager.cost_manager import CostManager
  ```
- **미사용 Import 제거**: `Ruff`를 통해 사용되지 않는 Import 구문은 자동으로 제거합니다.

### 3.2. 순환 참조 방지
- **계층 구조 준수**: `Service` → `Manager` → `Connector` 순서의 의존성을 가지므로, 하위 계층에서 상위 계층을 직접 Import하지 않습니다.
  - 예: `Connector`에서 `Manager`를 Import하면 순환 참조가 발생할 수 있습니다.
- **Type Hinting 활용**: 순환 참조가 불가피한 타입 힌트의 경우, `if TYPE_CHECKING:` 블록을 활용합니다.
  ```python
  from typing import TYPE_CHECKING

  if TYPE_CHECKING:
      from spaceone.inventory.manager.workspace_manager import WorkspaceManager
  ```

### 3.3. 개발 환경 및 의존성 관리
- **`spaceone` 패키지 Mocking**: 로컬에서 `spaceone` 관련 패키지 Import 오류 발생 시, 테스트나 개발에 필요한 부분만 Mock 객체로 처리하여 호환성을 유지합니다.
- **`spaceone-core` 의존성 해결**: 로컬 개발 환경에서 `spaceone-core` 버전 충돌이나 캐시 문제 발생 시, 다음 명령어를 통해 특정 버전을 강제로 재설치하여 문제를 해결할 수 있습니다.
  ```bash
  pip install --force-reinstall -v "spaceone-core==1.12.37"
  ```

---

## 4. 주석 및 문서화 (Comments & Documentation)

### 4.1. Docstrings (Google Style)
- 모든 공개 함수, 메서드, 클래스에는 Google 스타일 Docstring을 작성하여 `Args`, `Returns`, `Raises`를 명확히 합니다.
```python
def calculate_cost(usage_data: dict, rate: float = 0.1) -> float:
    """비용을 계산합니다.

    Args:
        usage_data: 사용량 데이터 딕셔너리.
        rate: 요금률 (기본값: 0.1).

    Returns:
        계산된 총 비용.

    Raises:
        ValueError: usage_data가 비어있을 경우.
    """
    if not usage_data:
        raise ValueError("Usage data cannot be empty.")
    # ...
```

### 4.2. 코드 내 주석
- **한국어 사용 원칙**: 코드의 의도를 설명하는 모든 주석(Docstring, 인라인 주석 등)은 이해를 돕기 위해 한국어로 작성하는 것을 원칙으로 합니다. 
- 복잡한 로직이나 특정 결정의 배경을 설명해야 할 때만 간결한 주석을 추가합니다. (`# 왜 이렇게 했는가?`)
- API 함수는 타입 힌트를 필수로 포함해야 합니다.

### 4.3. 프로젝트 문서
- **`README.md`**: 각 디렉토리의 목적과 주요 기능을 설명합니다. (국문 작성)
- **`GUIDE.md`**: 사용자 가이드로, 코드 변경으로 사용자에게 영향을 주는 경우 `en`, `ko` 디렉토리의 문서를 함께 업데이트해야 합니다.

---

## 5. 에러 처리 (Error Handling)

### 5.1. 예외 처리
- **구체적인 예외 명시**: `except Exception:` 보다 `except ValueError:` 와 같이 구체적인 예외를 잡습니다.
- **사용자에게 명확한 메시지 제공**: 에러 메시지는 문제 해결에 도움이 되도록 명확하고 간결하게 작성합니다. (영문 작성 원칙)
- **불필요한 변수 제거**: `except` 블록에서 예외 객체를 사용하지 않는다면 변수를 선언하지 않습니다.
  ```python
  # Good
  try:
      # ...
  except ValueError:
      _LOGGER.error("Invalid value provided.")
      raise

  # Bad
  except ValueError as e: # 'e' is not used
      _LOGGER.error("Invalid value provided.")
      raise
  ```

### 5.2. 예외 다시 발생 (Re-raising)
- **`raise from`**: 원래의 예외(cause)를 포함하여 디버깅을 용이하게 합니다.
  ```python
  except Exception as e:
      raise CustomError(f"Failed to process data: {e}") from e
  ```
- **`raise from None`**: 내부 구현을 숨기고 싶을 때 사용하되, 신중하게 결정합니다.

---

## 6. 테스트 (Testing)

### 6.1. 일반 규칙
- **테스트 작성**: 모든 새로운 기능과 버그 수정에는 테스트 코드를 함께 작성합니다.
- **독립성**: 테스트는 서로 의존하지 않고 독립적으로 실행 가능해야 합니다.
- **구조 (Given-When-Then)**: 테스트의 의도를 명확히 하기 위해 준비(Given), 실행(When), 검증(Then) 구조를 따릅니다.
- **Mock 활용**: 외부 서비스나 의존성은 `unittest.mock`을 사용하여 격리합니다.

### 6.2. gRPC API 테스트
- **직접 테스트의 한계**: `grpcurl`을 이용한 직접적인 API 테스트는 `SpaceONE` 환경 구성의 복잡성으로 인해 어렵습니다.
- **권장 방식**: 핵심 로직이 담긴 `Manager`나 `Connector`를 직접 임포트하여 단위 테스트나 통합 테스트 스크립트를 작성합니다.
  ```python
  # Manager 테스트 예시 (환경 변수 설정 필요)
  import os
  os.environ['SPACEONE_PACKAGE'] = 'plugin'
  from src.plugin.manager.cost_manager import CostManager
  # ... manager 테스트 로직 ...
  ```

---

## 7. 규칙 검증 스크립트

프로젝트 규칙 준수 여부를 확인하기 위해 다음 `grep` 커맨드를 활용할 수 있습니다.

- **클래스명 (PascalCase) 위배 확인**:
  ```bash
  grep -r "class [a-z_]" src/
  ```
- **함수/메서드명 (snake_case) 위배 확인**:
  ```bash
  grep -r "def [A-Z]" src/
  ```
- **미사용 예외 변수 `as e` 확인**:
  ```bash
  grep -r "except .* as e:" src/
  ```
